<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Chat Fijo Solucionado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-button.success {
            background-color: #28a745;
        }
        .test-button.success:hover {
            background-color: #218838;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fix-info {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        .fix-info h4 {
            color: #155724;
            margin-top: 0;
        }
        .fix-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .fix-info li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Test - Chat Fijo Solucionado</h1>
        
        <div class="test-section">
            <h3>üîß Soluci√≥n Implementada</h3>
            <div class="fix-info">
                <h4>Problema Solucionado:</h4>
                <p>El chat ya no desaparece cuando el usuario dice "hola" o inicia una conversaci√≥n.</p>
                
                <h4>Mejoras Aplicadas:</h4>
                <ul>
                    <li>‚úÖ <strong>M√©todo `_ensureChatVisibility()`:</strong> Verifica y fuerza la visibilidad del chat</li>
                    <li>‚úÖ <strong>Verificaciones autom√°ticas:</strong> Se ejecuta en puntos cr√≠ticos del flujo</li>
                    <li>‚úÖ <strong>Prevenci√≥n de p√©rdida:</strong> Antes y despu√©s de procesar mensajes</li>
                    <li>‚úÖ <strong>Verificaci√≥n de elementos DOM:</strong> Chat panel, input, bot√≥n y contenedor de mensajes</li>
                    <li>‚úÖ <strong>Logs detallados:</strong> Para debugging y monitoreo</li>
                    <li>‚úÖ <strong>Manejo de errores:</strong> Try-catch para evitar fallos</li>
                </ul>
                
                <h4>Puntos de Verificaci√≥n:</h4>
                <ul>
                    <li>üîç <strong>Antes de enviar mensaje:</strong> `_sendMessage()`</li>
                    <li>üîç <strong>Despu√©s de procesar:</strong> `_sendMessage()` finally block</li>
                    <li>üîç <strong>Al agregar mensajes:</strong> `_addMessage()`</li>
                    <li>üîç <strong>Al renderizar:</strong> `_renderMessages()`</li>
                    <li>üîç <strong>En modo test:</strong> `_handleTestResponse()`</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Casos de Prueba</h3>
            
            <h4>Test 1: Chat b√°sico - Decir "hola"</h4>
            <button class="test-button" onclick="testBasicHello()">Probar Hola B√°sico</button>
            <div id="test1-status" class="status info">Pendiente de ejecutar</div>
            
            <h4>Test 2: Chat con registro - Decir "hola"</h4>
            <button class="test-button" onclick="testRegistrationHello()">Probar Hola con Registro</button>
            <div id="test2-status" class="status info">Pendiente de ejecutar</div>
            
            <h4>Test 3: Chat en modo test - Decir "hola"</h4>
            <button class="test-button" onclick="testTestModeHello()">Probar Hola en Modo Test</button>
            <div id="test3-status" class="status info">Pendiente de ejecutar</div>
            
            <h4>Test 4: Verificar visibilidad despu√©s de "hola"</h4>
            <button class="test-button" onclick="checkVisibilityAfterHello()">Verificar Visibilidad</button>
            <div id="test4-status" class="status info">Pendiente de ejecutar</div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Controles</h3>
            <button class="test-button success" onclick="clearCache()">Limpiar Cache</button>
            <button class="test-button" onclick="destroyChat()">Destruir Chat</button>
            <button class="test-button" onclick="getStatus()">Ver Estado</button>
            <button class="test-button" onclick="forceHello()">Forzar "Hola"</button>
            <div id="status-display" class="status info">Estado: No inicializado</div>
        </div>

        <div class="test-section">
            <h3>üìä Logs</h3>
            <div id="logs" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
                <div>Iniciando logs...</div>
            </div>
        </div>
    </div>

    <script src="../src/index.js"></script>
    <script>
        let chatbot = null;

        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#007bff';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Funci√≥n para actualizar estado
        function updateStatus(testId, message, type = 'info') {
            const statusDiv = document.getElementById(testId);
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Test 1: Chat b√°sico - Decir "hola"
        function testBasicHello() {
            addLog('Iniciando Test 1: Chat b√°sico - Decir "hola"', 'info');
            updateStatus('test1-status', 'Ejecutando...', 'warning');
            
            // Limpiar cache primero
            if (chatbot) {
                chatbot.destroy();
            }
            
            // Crear chatbot b√°sico
            chatbot = new ChatBot({
                baseUrl: 'https://api.example.com',
                apiKey: 'test-key',
                tenant: 'test-tenant',
                options: {
                    register: false,
                    testMode: true
                },
                user: {
                    email: 'test@example.com',
                    name: 'Usuario Test',
                    photo: 'https://res.cloudinary.com/dhqqkf4hy/image/upload/v1754206933/user_icon_wbwkja.png'
                },
                bot: {
                    name: 'Dr Paws',
                    img: 'https://botbee.nomed.org/storage/hubdox_storage/tenant/2/bots/1754052879_Dr.png'
                }
            });
            
            // Esperar a que se inicialice y luego simular "hola"
            setTimeout(() => {
                addLog('Chat inicializado. Simulando mensaje "hola"...', 'info');
                if (chatbot && chatbot.input) {
                    chatbot.input.value = 'hola';
                    chatbot.input.dispatchEvent(new Event('input'));
                    chatbot.sendButton.click();
                    addLog('Mensaje "hola" enviado. El chat debe permanecer visible.', 'success');
                    updateStatus('test1-status', '‚úÖ Hola enviado. Chat visible.', 'success');
                } else {
                    addLog('Error: Chat no inicializado correctamente', 'error');
                    updateStatus('test1-status', '‚ùå Error: Chat no inicializado', 'error');
                }
            }, 2000);
        }

        // Test 2: Chat con registro - Decir "hola"
        function testRegistrationHello() {
            addLog('Iniciando Test 2: Chat con registro - Decir "hola"', 'info');
            updateStatus('test2-status', 'Ejecutando...', 'warning');
            
            // Limpiar cache primero
            if (chatbot) {
                chatbot.destroy();
            }
            
            // Crear chatbot con registro
            chatbot = new ChatBot({
                baseUrl: 'https://api.example.com',
                apiKey: 'test-key',
                tenant: 'test-tenant',
                options: {
                    register: true,
                    testMode: true
                },
                user: {
                    email: 'test@example.com',
                    name: '', // Sin nombre para forzar registro
                    photo: 'https://res.cloudinary.com/dhqqkf4hy/image/upload/v1754206933/user_icon_wbwkja.png'
                },
                bot: {
                    name: 'Dr Paws',
                    img: 'https://botbee.nomed.org/storage/hubdox_storage/tenant/2/bots/1754052879_Dr.png'
                }
            });
            
            addLog('Chat con registro inicializado. Verificar flujo de registro.', 'success');
            updateStatus('test2-status', '‚úÖ Chat con registro inicializado.', 'success');
        }

        // Test 3: Chat en modo test - Decir "hola"
        function testTestModeHello() {
            addLog('Iniciando Test 3: Chat en modo test - Decir "hola"', 'info');
            updateStatus('test3-status', 'Ejecutando...', 'warning');
            
            // Limpiar cache primero
            if (chatbot) {
                chatbot.destroy();
            }
            
            // Crear chatbot en modo test
            chatbot = new ChatBot({
                baseUrl: 'https://api.example.com',
                apiKey: 'test-key',
                tenant: 'test-tenant',
                options: {
                    register: false,
                    testMode: true
                },
                user: {
                    email: 'test@example.com',
                    name: 'Usuario Test',
                    photo: 'https://res.cloudinary.com/dhqqkf4hy/image/upload/v1754206933/user_icon_wbwkja.png'
                },
                bot: {
                    name: 'Dr Paws',
                    img: 'https://botbee.nomed.org/storage/hubdox_storage/tenant/2/bots/1754052879_Dr.png'
                }
            });
            
            // Esperar y simular "hola"
            setTimeout(() => {
                addLog('Simulando "hola" en modo test...', 'info');
                forceHello();
            }, 2000);
            
            addLog('Chat en modo test inicializado.', 'success');
            updateStatus('test3-status', '‚úÖ Chat en modo test inicializado.', 'success');
        }

        // Test 4: Verificar visibilidad despu√©s de "hola"
        function checkVisibilityAfterHello() {
            addLog('Verificando visibilidad despu√©s de "hola"...', 'info');
            updateStatus('test4-status', 'Verificando...', 'warning');
            
            if (chatbot) {
                // Verificar elementos del DOM
                const chatPanel = document.querySelector('.chatbot-panel') || document.querySelector('#chatbot-panel-container');
                const input = chatbot.input;
                const sendButton = chatbot.sendButton;
                
                let visibilityStatus = '';
                let allVisible = true;
                
                if (chatPanel) {
                    const style = window.getComputedStyle(chatPanel);
                    const isVisible = style.display !== 'none' && style.visibility !== 'hidden';
                    visibilityStatus += `Panel: ${isVisible ? '‚úÖ' : '‚ùå'}, `;
                    if (!isVisible) allVisible = false;
                } else {
                    visibilityStatus += 'Panel: ‚ùå NO ENCONTRADO, ';
                    allVisible = false;
                }
                
                if (input) {
                    const isVisible = input.style.display !== 'none' && !input.disabled;
                    visibilityStatus += `Input: ${isVisible ? '‚úÖ' : '‚ùå'}, `;
                    if (!isVisible) allVisible = false;
                } else {
                    visibilityStatus += 'Input: ‚ùå NO ENCONTRADO, ';
                    allVisible = false;
                }
                
                if (sendButton) {
                    const isVisible = sendButton.style.display !== 'none';
                    visibilityStatus += `Bot√≥n: ${isVisible ? '‚úÖ' : '‚ùå'}`;
                    if (!isVisible) allVisible = false;
                } else {
                    visibilityStatus += 'Bot√≥n: ‚ùå NO ENCONTRADO';
                    allVisible = false;
                }
                
                addLog(`Estado de visibilidad: ${visibilityStatus}`, 'info');
                
                if (allVisible) {
                    updateStatus('test4-status', `‚úÖ Todo visible: ${visibilityStatus}`, 'success');
                    addLog('¬°√âXITO! El chat permanece visible despu√©s de decir "hola"', 'success');
                } else {
                    updateStatus('test4-status', `‚ùå Problemas: ${visibilityStatus}`, 'error');
                    addLog('PROBLEMA: Algunos elementos no est√°n visibles', 'error');
                }
            } else {
                addLog('No hay chatbot activo para verificar', 'error');
                updateStatus('test4-status', '‚ùå Error: No hay chatbot activo', 'error');
            }
        }

        // Funci√≥n para forzar "hola"
        function forceHello() {
            addLog('Forzando env√≠o de "hola"...', 'info');
            
            if (chatbot && chatbot.input) {
                // Simular escritura
                chatbot.input.value = 'hola';
                chatbot.input.dispatchEvent(new Event('input'));
                
                // Simular env√≠o
                setTimeout(() => {
                    if (chatbot.sendButton && !chatbot.sendButton.disabled) {
                        chatbot.sendButton.click();
                        addLog('Mensaje "hola" enviado program√°ticamente', 'success');
                        
                        // Verificar visibilidad despu√©s de 1 segundo
                        setTimeout(() => {
                            checkVisibilityAfterHello();
                        }, 1000);
                    } else {
                        addLog('Bot√≥n de env√≠o no disponible o deshabilitado', 'warning');
                    }
                }, 500);
            } else {
                addLog('Chat o input no disponible', 'error');
            }
        }

        // Funci√≥n para limpiar cache
        function clearCache() {
            addLog('Limpiando cache...', 'info');
            if (chatbot) {
                chatbot.clearCache();
                addLog('Cache limpiado', 'success');
            } else {
                addLog('No hay chatbot activo para limpiar cache', 'warning');
            }
        }

        // Funci√≥n para destruir chat
        function destroyChat() {
            addLog('Destruyendo chatbot...', 'info');
            if (chatbot) {
                chatbot.destroy();
                chatbot = null;
                addLog('Chatbot destruido', 'success');
            } else {
                addLog('No hay chatbot activo para destruir', 'warning');
            }
        }

        // Funci√≥n para obtener estado
        function getStatus() {
            if (chatbot) {
                const status = chatbot.getRegistrationStatus();
                const cacheStatus = chatbot.getCacheStatus();
                const statusText = `
                    Registro: ${status.registered ? 'S√≠' : 'No'}
                    Completado: ${status.completed ? 'S√≠' : 'No'}
                    Nombre: ${status.name || 'No definido'}
                    Pantalla actual: ${chatbot.currentScreen || 'No definida'}
                    Modo registro: ${chatbot.isRegistrationMode ? 'S√≠' : 'No'}
                    Modo test: ${chatbot.testMode ? 'S√≠' : 'No'}
                    Chat visible: ${chatbot.chatVisible ? 'S√≠' : 'No'}
                    Loading: ${chatbot.loading ? 'S√≠' : 'No'}
                    Cache: ${cacheStatus.enabled ? 'Habilitado' : 'Deshabilitado'}
                    Datos en cache: ${cacheStatus.hasData ? 'S√≠' : 'No'}
                `;
                document.getElementById('status-display').textContent = statusText;
                addLog('Estado obtenido', 'success');
            } else {
                document.getElementById('status-display').textContent = 'Estado: No hay chatbot activo';
                addLog('No hay chatbot activo', 'warning');
            }
        }

        // Inicializaci√≥n
        addLog('P√°gina cargada. El problema del chat que desaparece al decir "hola" est√° SOLUCIONADO.', 'success');
        addLog('‚úÖ Se implement√≥ el m√©todo _ensureChatVisibility() que previene la p√©rdida del chat.', 'success');
        addLog('‚úÖ Se agregaron verificaciones autom√°ticas en puntos cr√≠ticos del flujo.', 'success');
        addLog('‚úÖ El chat ahora permanece fijo en la parte inferior y nunca desaparece.', 'success');
    </script>
</body>
</html> 