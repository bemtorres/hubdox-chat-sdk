<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modo Prueba - Estados de Conversaci√≥n - ChatBot SDK</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .status-info h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .status-item.active {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.info { color: #0066cc; }
        .log-entry.success { color: #28a745; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.error { color: #dc3545; }
        .test-mode-badge {
            background: #ffc107;
            color: #212529;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Modo Prueba - Estados de Conversaci√≥n</h1>
        
        <div class="test-mode-badge">
            üöÄ TEST MODE ACTIVADO
        </div>
        
        <div class="status-info">
            <h3>üìä Estado Actual de la Conversaci√≥n</h3>
            <div id="current-status">Cargando...</div>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="showStatus()">üîÑ Actualizar Estado</button>
            <button class="btn-success" onclick="showRegistrationStatus()">üìã Estado de Registro</button>
            <button class="btn-warning" onclick="clearHistory()">üóëÔ∏è Limpiar Historial</button>
            <button class="btn-info" onclick="showAllStatuses()">üìä Todos los Estados</button>
            <button class="btn-warning" onclick="simulateUserInteraction()">üé≠ Simular Interacci√≥n</button>
        </div>

        <div class="status-grid" id="status-grid">
            <!-- Los estados se mostrar√°n aqu√≠ din√°micamente -->
        </div>

        <div class="container">
            <h3>üìù Log de Actividad</h3>
            <div class="log" id="activity-log">
                <div class="log-entry info">Iniciando test de modo prueba con estados de conversaci√≥n...</div>
            </div>
        </div>
    </div>

    <script src="../src/index.js"></script>
    <script>
        let chatbot;
        let logCounter = 0;

        // Funci√≥n para agregar entradas al log
        function addLogEntry(message, type = 'info') {
            const log = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            logCounter++;
            
            // Limpiar log si hay demasiadas entradas
            if (logCounter > 100) {
                log.innerHTML = '';
                logCounter = 0;
            }
        }

        // Funci√≥n para mostrar el estado actual
        function showStatus() {
            if (!chatbot) {
                addLogEntry('‚ùå ChatBot no est√° inicializado', 'error');
                return;
            }

            try {
                const status = chatbot.getConversationStatus();
                addLogEntry(`‚úÖ Estado actual: ${status.currentStatus}`, 'success');
                
                // Actualizar la informaci√≥n del estado
                document.getElementById('current-status').innerHTML = `
                    <strong>Estado Actual:</strong> ${status.currentStatus}<br>
                    <strong>Usuario:</strong> ${status.user.name || 'No definido'}<br>
                    <strong>Email:</strong> ${status.user.email || 'No definido'}<br>
                    <strong>Modo Prueba:</strong> ${chatbot.testMode ? 'Activado' : 'Desactivado'}
                `;
                
                // Actualizar la cuadr√≠cula de estados
                updateStatusGrid(status);
                
            } catch (error) {
                addLogEntry(`‚ùå Error obteniendo estado: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para mostrar el estado de registro
        function showRegistrationStatus() {
            if (!chatbot) {
                addLogEntry('‚ùå ChatBot no est√° inicializado', 'error');
                return;
            }

            try {
                const status = chatbot.getRegistrationStatus();
                addLogEntry(`üìã Estado de registro obtenido`, 'info');
                addLogEntry(`   - Registrado: ${status.registered}`, 'info');
                addLogEntry(`   - Pantalla de registro: ${status.registrationScreen}`, 'info');
                addLogEntry(`   - Registro completado: ${status.registrationCompleted}`, 'info');
                addLogEntry(`   - Sesi√≥n: ${status.session}`, 'info');
                addLogEntry(`   - Licencia activa: ${status.licenseActive}`, 'info');
                
            } catch (error) {
                addLogEntry(`‚ùå Error obteniendo estado de registro: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para limpiar el historial
        function clearHistory() {
            if (!chatbot) {
                addLogEntry('‚ùå ChatBot no est√° inicializado', 'error');
                return;
            }

            try {
                chatbot.clearHistory();
                addLogEntry(`üóëÔ∏è Historial limpiado`, 'success');
                
                // Esperar un momento y luego actualizar el estado
                setTimeout(() => {
                    showStatus();
                }, 1000);
                
            } catch (error) {
                addLogEntry(`‚ùå Error limpiando historial: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para mostrar todos los estados
        function showAllStatuses() {
            if (!chatbot) {
                addLogEntry('‚ùå ChatBot no est√° inicializado', 'error');
                return;
            }

            try {
                const convStatus = chatbot.getConversationStatus();
                const regStatus = chatbot.getRegistrationStatus();
                
                addLogEntry(`üìä Estado completo de la conversaci√≥n:`, 'info');
                addLogEntry(`   Conversaci√≥n: ${convStatus.currentStatus}`, 'info');
                addLogEntry(`   Registrado: ${regStatus.registered}`, 'info');
                addLogEntry(`   Registro completado: ${regStatus.registrationCompleted}`, 'info');
                addLogEntry(`   Usuario: ${convStatus.user.name || 'No definido'}`, 'info');
                addLogEntry(`   Modo Prueba: ${chatbot.testMode ? 'Activado' : 'Desactivado'}`, 'info');
                
            } catch (error) {
                addLogEntry(`‚ùå Error obteniendo estados: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para simular interacciones del usuario
        function simulateUserInteraction() {
            if (!chatbot) {
                addLogEntry('‚ùå ChatBot no est√° inicializado', 'error');
                return;
            }

            addLogEntry('üé≠ Simulando interacci√≥n del usuario...', 'info');
            
            // Simular clic en "Iniciar Conversaci√≥n"
            setTimeout(() => {
                try {
                    chatbot._startNormalChat();
                    addLogEntry('‚úÖ Simulado clic en "Iniciar Conversaci√≥n"', 'success');
                    showStatus();
                } catch (error) {
                    addLogEntry(`‚ùå Error simulando interacci√≥n: ${error.message}`, 'error');
                }
            }, 1000);
        }

        // Funci√≥n para actualizar la cuadr√≠cula de estados
        function updateStatusGrid(status) {
            const grid = document.getElementById('status-grid');
            grid.innerHTML = '';
            
            const statuses = [
                {
                    key: 'PRESENTATION',
                    label: 'Presentaci√≥n',
                    description: 'Bot se presenta y muestra men√∫',
                    isActive: status.isPresentation
                },
                {
                    key: 'ASKING_NAME',
                    label: 'Preguntando Nombre',
                    description: 'Solicitando nombre del usuario',
                    isActive: status.isAskingName
                },
                {
                    key: 'CHAT_READY',
                    label: 'Chat Listo',
                    description: 'Conversaci√≥n activa',
                    isActive: status.isChatReady
                }
            ];
            
            statuses.forEach(statusItem => {
                const item = document.createElement('div');
                item.className = `status-item ${statusItem.isActive ? 'active' : ''}`;
                item.innerHTML = `
                    <strong>${statusItem.label}</strong><br>
                    <small>${statusItem.description}</small><br>
                    <span style="color: ${statusItem.isActive ? '#155724' : '#6c757d'}">
                        ${statusItem.isActive ? '‚úÖ Activo' : '‚è∏Ô∏è Inactivo'}
                    </span>
                `;
                grid.appendChild(item);
            });
        }

        // Inicializar el chatbot cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('üöÄ Inicializando ChatBot en modo prueba...', 'info');
            
            try {
                // Configurar el chatbot con testMode: true
                chatbot = new ChatBot({
                    baseUrl: 'https://api.example.com',
                    apiKey: 'test-api-key',
                    tenant: 'test-tenant',
                    options: {
                        testMode: true,        // ¬°MODO PRUEBA ACTIVADO!
                        register: false,
                        devMode: true,
                        stream: false          // Desactivar streaming para pruebas m√°s claras
                    },
                    user: {
                        name: null, // Usuario sin nombre para probar el flujo
                        email: null,
                        photo: "https://res.cloudinary.com/dhqqkf4hy/image/upload/v1754206933/user_icon_wbwkja.png"
                    },
                    bot: {
                        name: "Bot de Prueba",
                        img: "https://res.cloudinary.com/dhqqkf4hy/image/upload/v1754206932/bot_icon_zgo153.png"
                    },
                    custom: {
                        primaryColor: "#007bff",
                        showTime: true
                    }
                });
                
                addLogEntry('‚úÖ ChatBot inicializado correctamente en modo prueba', 'success');
                addLogEntry('üîç Verificando que testMode est√© activado...', 'info');
                
                if (chatbot.testMode) {
                    addLogEntry('‚úÖ testMode est√° activado correctamente', 'success');
                } else {
                    addLogEntry('‚ùå testMode NO est√° activado', 'error');
                }
                
                // Mostrar el estado inicial
                setTimeout(() => {
                    showStatus();
                }, 2000);
                
            } catch (error) {
                addLogEntry(`‚ùå Error inicializando ChatBot: ${error.message}`, 'error');
            }
        });

        // Funci√≥n para probar el flujo completo
        function testCompleteFlow() {
            if (!chatbot) {
                addLogEntry('‚ùå ChatBot no est√° inicializado', 'error');
                return;
            }

            addLogEntry('üß™ Iniciando test del flujo completo...', 'info');
            
            // Paso 1: Verificar estado inicial
            setTimeout(() => {
                addLogEntry('üìã Paso 1: Verificando estado inicial (PRESENTATION)', 'info');
                showStatus();
            }, 1000);
            
            // Paso 2: Simular clic en "Iniciar Conversaci√≥n"
            setTimeout(() => {
                addLogEntry('üé≠ Paso 2: Simulando clic en "Iniciar Conversaci√≥n"', 'info');
                chatbot._startNormalChat();
                showStatus();
            }, 3000);
            
            // Paso 3: Simular entrada del nombre
            setTimeout(() => {
                addLogEntry('‚úçÔ∏è Paso 3: Simulando entrada del nombre "Juan"', 'info');
                chatbot.input.value = 'Juan';
                chatbot._sendMessage();
                showStatus();
            }, 5000);
            
            // Paso 4: Verificar estado final
            setTimeout(() => {
                addLogEntry('‚úÖ Paso 4: Verificando estado final (CHAT_READY)', 'info');
                showStatus();
            }, 7000);
        }

        // Agregar bot√≥n de test completo
        const controlsDiv = document.querySelector('.controls');
        const testFlowBtn = document.createElement('button');
        testFlowBtn.className = 'btn-success';
        testFlowBtn.textContent = 'üß™ Test Flujo Completo';
        testFlowBtn.onclick = testCompleteFlow;
        controlsDiv.appendChild(testFlowBtn);
    </script>
</body>
</html>
